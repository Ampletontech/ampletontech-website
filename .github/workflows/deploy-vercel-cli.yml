name: Deploy to Vercel (dev and main)

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch: # Allows manual triggering
  repository_dispatch: # Allows triggering via external webhooks (deploy hooks)
    types: [deploy_event]

jobs:
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Determine deployment type
        id: deployment
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "type=production" >> $GITHUB_OUTPUT
            echo "Deploying to PRODUCTION"
          else
            echo "type=preview" >> $GITHUB_OUTPUT
            echo "Deploying to PREVIEW"
          fi

      - name: Deploy to Vercel (Preview for dev branch)
        if: steps.deployment.outputs.type == 'preview'
        run: |
          # Define commit message with fallback
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ -z "$COMMIT_MSG" ]]; then
            COMMIT_MSG="Deployment triggered via ${{ github.event_name }} (${{ github.sha }})"
          fi

          npx vercel --yes \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ secrets.VERCEL_ORG_ID }} \
            -m githubCommitSha=${{ github.sha }} \
            -m githubCommitAuthorName=${{ github.actor }} \
            -m githubCommitAuthorLogin=${{ github.actor }} \
            -m githubDeployment=1 \
            -m githubOrg=${{ github.repository_owner }} \
            -m githubRepo=${{ github.event.repository.name }} \
            -m githubCommitOrg=${{ github.repository_owner }} \
            -m githubCommitRepo=${{ github.event.repository.name }} \
            -m githubCommitMessage="$COMMIT_MSG" \
            -m githubCommitRef=${{ github.ref_name }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel (Production for main/master branch)
        if: steps.deployment.outputs.type == 'production'
        run: |
          # Define commit message with fallback
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ -z "$COMMIT_MSG" ]]; then
            COMMIT_MSG="Deployment triggered via ${{ github.event_name }} (${{ github.sha }})"
          fi

          npx vercel --prod --yes \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ secrets.VERCEL_ORG_ID }} \
            -m githubCommitSha=${{ github.sha }} \
            -m githubCommitAuthorName=${{ github.actor }} \
            -m githubCommitAuthorLogin=${{ github.actor }} \
            -m githubDeployment=1 \
            -m githubOrg=${{ github.repository_owner }} \
            -m githubRepo=${{ github.event.repository.name }} \
            -m githubCommitOrg=${{ github.repository_owner }} \
            -m githubCommitRepo=${{ github.event.repository.name }} \
            -m githubCommitMessage="$COMMIT_MSG" \
            -m githubCommitRef=${{ github.ref_name }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
