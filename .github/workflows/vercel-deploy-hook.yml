name: Vercel Deploy Hook Trigger

on:
  repository_dispatch:
    types: [vercel-deploy]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - main
          - master

jobs:
  deploy:
    name: Deploy via Webhook
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.event.client_payload.ref || 'dev' }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Determine deployment type
        id: deployment
        run: |
          BRANCH="${{ github.event.inputs.branch || github.event.client_payload.ref || 'dev' }}"
          if [[ "$BRANCH" == "main" ]] || [[ "$BRANCH" == "master" ]]; then
            echo "type=production" >> $GITHUB_OUTPUT
            echo "Deploying to PRODUCTION"
          else
            echo "type=preview" >> $GITHUB_OUTPUT
            echo "Deploying to PREVIEW"
          fi

      - name: Deploy to Vercel (Preview)
        if: steps.deployment.outputs.type == 'preview'
        run: |
          npx vercel \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ secrets.VERCEL_ORG_ID }} \
            --yes
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel (Production)
        if: steps.deployment.outputs.type == 'production'
        run: |
          npx vercel --prod \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ secrets.VERCEL_ORG_ID }} \
            --yes
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

